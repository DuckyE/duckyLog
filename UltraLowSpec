-- UltraLow SAFE-LOW (no Players) – chunked, no heavy event hooks
-- - Kills major VFX, lowers lighting/terrain, degrades meshes/textures in batches
-- - Hides ONLY workspace.Pets locally
-- - F8 = rescan (safe), F9 = toggle 3D render (optional)

local UIS        = game:GetService("UserInputService")
local Lighting   = game:GetService("Lighting")
local RunService = game:GetService("RunService")

local PETS = workspace:FindFirstChild("Pets")
local FXF  = workspace:FindFirstChild("FX") -- ถ้ามีโฟลเดอร์เอฟเฟกต์รวม จะเร็วขึ้น

-- ===== Helper: process in batches to avoid freezes =====
local BATCH = 400
local function batched(list, fn)
	for i = 1, #list do
		local o = list[i]
		fn(o)
		if (i % BATCH) == 0 then task.wait() end
	end
end

-- ===== Quality (wrapped) =====
pcall(function()
	UserSettings():GetService("UserGameSettings").SavedQualityLevel = Enum.SavedQualitySetting.QualityLevel1
end)

-- ===== Lighting / Atmosphere / Sky =====
local function isPostEffect(x)
	return x:IsA("BlurEffect") or x:IsA("BloomEffect")
		or x:IsA("DepthOfFieldEffect") or x:IsA("SunRaysEffect")
		or x:IsA("ColorCorrectionEffect")
end

local function tameLighting()
	for _,o in ipairs(Lighting:GetDescendants()) do
		if isPostEffect(o) then pcall(function() o.Enabled=false end)
		elseif o:IsA("Atmosphere") then
			pcall(function()
				o.Density, o.Haze, o.Glare = 0,0,0
				o.Color, o.Decay = Color3.new(1,1,1), Color3.new(1,1,1)
			end)
		elseif o:IsA("Sky") then
			pcall(function() o.Parent=nil end)
		end
	end
	-- low numbers
	pcall(function()
		Lighting.EnvironmentSpecularScale=0
		Lighting.EnvironmentDiffuseScale=0
		Lighting.Brightness=1
		Lighting.GlobalShadows=false
		Lighting.FogStart=0; Lighting.FogEnd=9e9
		Lighting.Ambient=Color3.fromRGB(128,128,128)
		Lighting.OutdoorAmbient=Color3.fromRGB(128,128,128)
		Lighting.Technology = Enum.Technology.Compatibility
	end)
end

local function reduceTerrainWater()
	local t = workspace.Terrain
	pcall(function()
		t.WaterWaveSize=0; t.WaterWaveSpeed=0
		t.WaterReflectance=0; t.WaterTransparency=1
	end)
end

-- ===== Kill VFX / Lights (one-shot, no Changed hooks) =====
local function killOne(o)
	if o:IsA("ParticleEmitter") then
		pcall(function()
			o.Enabled=false; o.Rate=0; o.Lifetime=NumberRange.new(0,0)
			o.Transparency=NumberSequence.new(1); o.LightEmission=0; o.LightInfluence=0
			o:Clear()
		end)
	elseif o:IsA("Trail") then
		pcall(function() o.Enabled=false; o.Lifetime=0; o.Transparency=NumberSequence.new(1) end)
	elseif o:IsA("Beam") then
		pcall(function() o.Enabled=false; o.Transparency=NumberSequence.new(1); o.Width0, o.Width1=0,0; o.TextureSpeed=0 end)
	elseif o:IsA("Fire") then
		pcall(function() o.Enabled=false; if o.Size then o.Size=0 end end)
	elseif o:IsA("Smoke") then
		pcall(function() o.Enabled=false; if o.Opacity then o.Opacity=0 end end)
	elseif o:IsA("Sparkles") then
		pcall(function() o.Enabled=false end)
	elseif o:IsA("Highlight") then
		pcall(function() o.Enabled=false; o.FillTransparency=1; o.OutlineTransparency=1 end)
	elseif o:IsA("Explosion") then
		pcall(function() o.Visible=false; o.BlastPressure=0; o.BlastRadius=0 end)
	elseif o:IsA("BillboardGui") or o:IsA("SurfaceGui") then
		pcall(function() o.Enabled=false end)
	elseif o:IsA("PointLight") or o:IsA("SpotLight") or o:IsA("SurfaceLight") then
		pcall(function() o.Enabled=false; o.Brightness=0; o.Range=0 end)
	end
end

-- ===== Degrade visuals (cheap) =====
local function degradeOne(o)
	if o:IsA("MeshPart") then
		pcall(function()
			o.RenderFidelity = Enum.RenderFidelity.Performance
			o.CastShadow=false; o.Reflectance=0
			local sa=o:FindFirstChildOfClass("SurfaceAppearance"); if sa then sa.Enabled=false end
		end)
	elseif o:IsA("BasePart") then
		pcall(function() o.CastShadow=false; o.Reflectance=0 end)
	elseif o:IsA("Decal") or o:IsA("Texture") then
		pcall(function() o.Transparency=1 end)
	elseif o:IsA("SurfaceAppearance") then
		pcall(function() o.Enabled=false end)
	end
end

-- ===== Hide ONLY workspace.Pets =====
local function hidePets()
	if not PETS then return end
	local lst = PETS:GetDescendants()
	batched(lst, function(d)
		if d:IsA("BasePart") then
			pcall(function()
				d.LocalTransparencyModifier = 1
				d.CastShadow=false
				d.CanCollide=false
			end)
		elseif d:IsA("Decal") or d:IsA("Texture") then
			pcall(function() d.Transparency=1 end)
		elseif d:IsA("SurfaceAppearance") then
			pcall(function() d.Enabled=false end)
		else
			killOne(d)
		end
	end)
end

-- ===== Animator stopper =====
local function stopAllAnim()
	local anims = workspace:GetDescendants()
	batched(anims, function(o)
		if o:IsA("Animator") then
			pcall(function()
				for _, tr in ipairs(o:GetPlayingAnimationTracks()) do tr:Stop(0) end
			end)
		elseif o:IsA("LocalScript") and o.Name=="Animate" then
			pcall(function() o.Disabled=true end)
		end
	end)
end

-- ===== Main passes (chunked) =====
local function scanAll()
	tameLighting()
	reduceTerrainWater()
	stopAllAnim()

	-- 1) เอฟเฟกต์หนักๆ ทั้งแผนที่ (โฟลเดอร์ FX ถ้ามีจะไวขึ้นก่อน)
	if FXF then
		local ds = FXF:GetDescendants()
		batched(ds, function(o) killOne(o); degradeOne(o) end)
	end

	-- 2) ทั้ง workspace (ยกเว้น Pets เดี๋ยวทำเฉพาะอีกที)
	local all = workspace:GetDescendants()
	batched(all, function(o)
		if PETS and (o == PETS or o:IsDescendantOf(PETS)) then return end
		killOne(o); degradeOne(o)
	end)

	-- 3) ซ่อน Pets
	hidePets()
end

-- ===== Light hook for new spawns (simple, no Changed hooks) =====
workspace.DescendantAdded:Connect(function(o)
	-- งานน้อย: แค่ปิดของที่เป็นเอฟเฟกต์/ไฟ + degrade ของใหม่ทีเดียว
	killOne(o)
	degradeOne(o)
	-- ถ้ามาเกิดใน Pets ให้ซ่อน
	if PETS and (o:IsDescendantOf(PETS) or o==PETS) then
		if o:IsA("BasePart") then
			pcall(function() o.LocalTransparencyModifier=1; o.CastShadow=false; o.CanCollide=false end)
		end
	end
end)
Lighting.DescendantAdded:Connect(function(o)
	if isPostEffect(o) then pcall(function() o.Enabled=false end)
	elseif o:IsA("Atmosphere") then pcall(function() o.Density=0; o.Haze=0; o.Glare=0; o.Color=Color3.new(1,1,1); o.Decay=Color3.new(1,1,1) end)
	elseif o:IsA("Sky") then pcall(function() o.Parent=nil end)
	end
end)

-- ===== Hotkeys =====
local RENDER_OFF=false
UIS.InputBegan:Connect(function(input,gp)
	if gp then return end
	if input.KeyCode==Enum.KeyCode.F8 then
		scanAll()
		print("[SAFE-LOW] re-applied.")
	elseif input.KeyCode==Enum.KeyCode.F9 then
		RENDER_OFF = not RENDER_OFF
		pcall(function() RunService:Set3dRenderingEnabled(not RENDER_OFF) end)
		print(RENDER_OFF and "[SAFE-LOW] 3D DISABLED" or "[SAFE-LOW] 3D ENABLED")
	end
end)

-- ===== Start (chunked) =====
task.spawn(function() scanAll() end)
print("[SAFE-LOW] applied (chunked).")
